import ApiRequest
import re


class Bittrex:
    def __init__(self):
        self.__name = "BITTREX"
        self.__URL_BUILD_CONTAINER = {
            "URL": "https://api.bittrex.com/v3/markets/",
            "market_info_URL": "https://api.bittrex.com/v3/markets/",
            "orderbook_endpoint": "orderbook",
            "withdrawal_fees_endpoint": "https://api.bittrex.com/v3/currencies",
            "rates_endpoint": "ticker"
        }

        self.__upper_bound_currency = "USD"
        self.__maker_taker_fees = [{"upper_bound": 5000, "takerFee": 0.0075, "makerFee": 0.0075},
                                   {"upper_bound": 10000, "takerFee": 0.0050, "makerFee": 0.0050},
                                   {"upper_bound": 25000, "takerFee": 0.0035, "makerFee": 0.0035},
                                   {"upper_bound": 50000, "takerFee": 0.0020, "makerFee": 0.0025},
                                   {"upper_bound": 1000000, "takerFee": 0.0012, "makerFee": 0.0018},
                                   {"upper_bound": 10000000, "takerFee": 0.0005, "makerFee": 0.0015},
                                   {"upper_bound": 60000000, "takerFee": 0, "makerFee": 0.0008},
                                   {"takerFee": 0, "makerFee": 0.0005}]
        self.__withdrawal_fees = {
            "1INCH": 34.00000000,
            "1ST": 4.50000000,
            "4ART": 1566.00000000,
            "AAPL": 0.00000000,
            "AAVE": 1.65000000,
            "ABBC": 0.10000000,
            "ABNB": 0.00000000,
            "ABT": 72.00000000,
            "ABYSS": 5706.00000000,
            "ACB": 0.00000000,
            "ACXT": 1.00000000,
            "ADA": 1.00000000,
            "ADABEAR": 12.64000000,
            "ADABULL": 0.00400000,
            "ADK": 0.00000000,
            "ADT": 129495.00000000,
            "ADX": 178.00000000,
            "AEON": 0.10000000,
            "AERGO": 119.00000000,
            "AGRS": 172.00000000,
            "AID": 1004.00000000,
            "AKN": 0.10000000,
            "AKRO": 6604.00000000,
            "ALGO": 0.10000000,
            "AMC": 0.00000000,
            "AMD": 0.00000000,
            "AMP": 9215.00000000,
            "AMZN": 0.00000000,
            "ANKR": 1439.00000000,
            "ANT": 23.00000000,
            "APHA": 0.00000000,
            "APIX": 40.00000000,
            "APM": 7063.00000000,
            "AR": 1.00000000,
            "ARDR": 2.00000000,
            "ARDX": 2195.00000000,
            "ARK": 0.10000000,
            "ARKK": 0.00000000,
            "ART": 1427.00000000,
            "ATOM": 0.00400000,
            "AVAX": 0.00100000,
            "BABA": 0.00000000,
            "BAL": 3.00000000,
            "BAND": 33.00000000,
            "BAT": 165.00000000,
            "BB": 0.00000000,
            "BBC": 0.01000000,
            "BCH": 0.00100000,
            "BCPT": 276.00000000,
            "BEAR": 9.00000000,
            "BEST": 20.00000000,
            "BFT": 1537.00000000,
            "BILI": 0.00000000,
            "BITW": 0.00000000,
            "BLK": 0.02000000,
            "BLOC": 21409.00000000,
            "BLOCK": 0.02000000,
            "BLT": 125.00000000,
            "BLTV": 5352.00000000,
            "BNT": 27.00000000,
            "BNTX": 0.00000000,
            "BOA": 714.00000000,
            "BONDLY": 679.00000000,
            "BORA": 1006.00000000,
            "BOXX": 275.00000000,
            "BRZ": 1143.00000000,
            "BSV": 0.00100000,
            "BTC": 0.00030000,
            "BTCV": 0.01000000,
            "BTE": 183.00000000,
            "BTM": 0.10000000,
            "BTS": 5.00000000,
            "BTT": 1.00000000,
            "BTU": 339.00000000,
            "BTXCRD": 0.01000000,
            "BULL": 0.00170000,
            "BURST": 2.00000000,
            "BWF": 14942.00000000,
            "BWX": 2326.00000000,
            "BYND": 0.00000000,
            "CAMP": 388486.00000000,
            "CBC": 2921.00000000,
            "CEL": 30.00000000,
            "CELO": 0.01000000,
            "CGC": 0.00000000,
            "CGT": 10.00000000,
            "CHR": 188.00000000,
            "CKB": 0.01000000,
            "CLT": 14.00000000,
            "CMCT": 10704.00000000,
            "CND": 14418.00000000,
            "CNS": 0.05000000,
            "CNTM": 706.00000000,
            "COIN": 0.00000000,
            "COMP": 0.25000000,
            "COSM": 1.00000000,
            "CPC": 14942.00000000,
            "CPT": 1.00000000,
            "CRO": 0.01000000,
            "CRON": 0.00000000,
            "CRW": 0.02000000,
            "CTC": 55.00000000,
            "CTXC": 0.01000000,
            "CURE": 0.00020000,
            "CUSD": 0.01000000,
            "CUT": 818.00000000,
            "CVC": 428.00000000,
            "CVT": 1210.00000000,
            "DAF": 174.00000000,
            "DAI": 212.00000000,
            "DASH": 0.05000000,
            "DAWN": 48.00000000,
            "DCR": 0.01000000,
            "DENT": 1881.00000000,
            "DEP": 22852.00000000,
            "DFI": 0.10000000,
            "DGB": 0.20000000,
            "DMT": 214.00000000,
            "DNA": 0.01000000,
            "DNT": 1854.00000000,
            "DOGE": 5.00000000,
            "DOGEBULL": 0.00010000,
            "DOT": 0.50000000,
            "DRGN": 897.00000000,
            "DTA": 30.00000000,
            "DUCATO": 7.00000000,
            "DUSK": 932.00000000,
            "ECELL": 3735.00000000,
            "ECOC": 0.01000000,
            "EDGELESS": 765.00000000,
            "EDR": 3292.00000000,
            "ELA": 0.01000000,
            "ELAMA": 11100.00000000,
            "ELF": 38.00000000,
            "EMC2": 0.20000000,
            "ENG": 1270.00000000,
            "ENJ": 95.00000000,
            "EOS": 0.10000000,
            "ETC": 0.01000000,
            "ETH": 0.02450000,
            "ETHBEAR": 100.00000000,
            "ETHBULL": 0.01300000,
            "EUR": 0.00000000,
            "EXCL": 0.20000000,
            "EXE": 43165.00000000,
            "EXP": 0.01000000,
            "FB": 0.00000000,
            "FCT": 0.01000000,
            "FCT2": 1245.00000000,
            "FET": 88.00000000,
            "FIL": 0.04000000,
            "FIRO": 0.10000000,
            "FIT": 64748.00000000,
            "FLETA": 9712.00000000,
            "FLO": 0.20000000,
            "FME": 97121.00000000,
            "FNB": 38849.00000000,
            "FOL": 122.00000000,
            "FOR": 2459.00000000,
            "FRSP": 388486.00000000,
            "FSN": 0.00600000,
            "FTC": 0.20000000,
            "FTM": 432.00000000,
            "FUN": 1600.00000000,
            "FX": 337.00000000,
            "GAME": 848.00000000,
            "GBYTE": 0.00200000,
            "GDXJ": 0.00000000,
            "GEO": 0.10000000,
            "GET": 48.00000000,
            "GLD": 0.00000000,
            "GLEEC": 0.10000000,
            "GLM": 497.00000000,
            "GLXY": 0.00000000,
            "GME": 0.00000000,
            "GNC": 0.01000000,
            "GNO": 0.80000000,
            "GNY": 170.00000000,
            "GO": 1.00000000,
            "GOLD": 46.16000000,
            "GOOGL": 0.00000000,
            "GRIN": 0.10000000,
            "GRS": 0.20000000,
            "GRT": 149.00000000,
            "GST": 0.10000000,
            "GTO": 3184.00000000,
            "GUP": 2487.00000000,
            "GXC": 0.30000000,
            "HBAR": 0.10000000,
            "HBD": 0.01000000,
            "HDAC": 1.00000000,
            "HDAO": 13874.00000000,
            "HEDG": 148.00000000,
            "HINT": 2666.00000000,
            "HIVE": 0.01000000,
            "HMQ": 21583.00000000,
            "HNS": 0.10000000,
            "HXRO": 330.00000000,
            "HYC": 2288.00000000,
            "HYDRO": 25591.00000000,
            "ICX": 0.02000000,
            "IGNIS": 2.00000000,
            "IHT": 3568.00000000,
            "INCNT": 0.10000000,
            "INSTAR": 0.10000000,
            "INX": 97121.00000000,
            "INXT": 25.00000000,
            "IOC": 0.20000000,
            "ION": 0.20000000,
            "IOST": 1.00000000,
            "IOTA": 0.50000000,
            "IOTX": 3846.00000000,
            "IQQ": 2158.00000000,
            "IRIS": 0.10000000,
            "ITM": 1.00000000,
            "JOB": 129495.00000000,
            "KAI": 1423.00000000,
            "KDA": 0.10000000,
            "KDAG": 388.00000000,
            "KLAY": 0.00600000,
            "KLV": 5.50000000,
            "KMD": 0.00200000,
            "KNC": 65.00000000,
            "KOK": 234.00000000,
            "KRT": 3625.00000000,
            "KSM": 0.10000000,
            "LAMB": 3059.00000000,
            "LBC": 0.02000000,
            "LCS": 1.00000000,
            "LINK": 4.50000000,
            "LMCH": 97121.00000000,
            "LOOM": 1632.00000000,
            "LOON": 4465.00000000,
            "LRC": 288.00000000,
            "LSK": 0.10000000,
            "LTC": 0.01000000,
            "LUCY": 0.20000000,
            "LUNA": 2.20000000,
            "MAID": 10.00000000,
            "MANA": 160.00000000,
            "MARO": 0.00600000,
            "MATIC": 188.00000000,
            "MCH": 94.71000000,
            "MDT": 3265.00000000,
            "ME": 15539.00000000,
            "MED": 10.00000000,
            "MEME": 0.02000000,
            "MER": 0.10000000,
            "MET": 39.00000000,
            "META": 0.00600000,
            "MFA": 13874.00000000,
            "MFT": 14388.00000000,
            "MKR": 0.03790000,
            "MLN": 0.32000000,
            "MMAON": 533.00000000,
            "MOBI": 1.00000000,
            "MOC": 1573.00000000,
            "MOF": 558.00000000,
            "MOGX": 1.00000000,
            "MONA": 0.20000000,
            "MORE": 2524.00000000,
            "MRNA": 0.00000000,
            "MRPH": 127.00000000,
            "MSTR": 0.00000000,
            "MTC": 0.00000000,
            "MTL": 57.00000000,
            "MUE": 0.02000000,
            "MYID": 2065.00000000,
            "MYST": 279.00000000,
            "NAV": 0.20000000,
            "NCASH": 6705.00000000,
            "NDAU": 0.10000000,
            "NEO": 0.02500000,
            "NFLX": 0.00000000,
            "NFTX": 1.00000000,
            "NGC": 4133.00000000,
            "NIO": 0.00000000,
            "NKN": 375.00000000,
            "NLC2": 0.10000000,
            "NLG": 0.20000000,
            "NMR": 3.50000000,
            "NOK": 0.00000000,
            "NPXS": 46649.00000000,
            "NVDA": 0.00000000,
            "NVT": 0.04000000,
            "NXS": 0.20000000,
            "NXT": 2.00000000,
            "OCEAN": 327.00000000,
            "OCN": 16293.00000000,
            "OGN": 149.00000000,
            "OGO": 571.00000000,
            "OGT": 344.00000000,
            "OK": 0.20000000,
            "OMG": 20.00000000,
            "OMNI": 0.10000000,
            "ONG": 0.10000000,
            "ONT": 1.00000000,
            "ORBS": 1646.00000000,
            "OST": 389.00000000,
            "OXEN": 0.20000000,
            "OXT": 348.00000000,
            "PAL": 1.00000000,
            "PANDO": 26.93000000,
            "PART": 0.10000000,
            "PAX": 211.00000000,
            "PAY": 1299.00000000,
            "PENN": 0.00000000,
            "PFE": 0.00000000,
            "PHNX": 1110.00000000,
            "PI": 1.00000000,
            "PINK": 0.20000000,
            "PIST": 0.45000000,
            "PIVX": 0.02000000,
            "PLA": 129495.00000000,
            "PLG": 21409.00000000,
            "PMA": 388486.00000000,
            "POLC": 1.00000000,
            "POLY": 170.00000000,
            "POT": 0.00200000,
            "POWR": 547.00000000,
            "PPC": 0.02000000,
            "PRO": 49.00000000,
            "PROM": 7.00000000,
            "PROS": 1.55000000,
            "PTON": 388486.00000000,
            "PTOY": 6698.00000000,
            "PXL": 1.00000000,
            "PYPL": 0.00000000,
            "QCX": 651.00000000,
            "QLC": 0.00000000,
            "QNT": 5.00000000,
            "QRL": 0.10000000,
            "QTUM": 0.01000000,
            "RCN": 1566.00000000,
            "RDD": 2.00000000,
            "REN": 230.00000000,
            "RENBTC": 0.00390000,
            "REPV2": 7.00000000,
            "REV": 11389.00000000,
            "REVV": 875.00000000,
            "RFOX": 885.00000000,
            "RFR": 5352.00000000,
            "RGT": 1.00000000,
            "RLC": 27.00000000,
            "ROOM": 189.00000000,
            "RSR": 2755.00000000,
            "RSV": 1.00000000,
            "RVC": 1.00000000,
            "RVN": 1.00000000,
            "SAND": 166.00000000,
            "SBD": 0.01000000,
            "SBT": 7520.00000000,
            "SC": 0.10000000,
            "SDT": 2.20000000,
            "SENSO": 113.00000000,
            "SG": 0.76140000,
            "SHR": 9664.00000000,
            "SIB": 0.20000000,
            "SIG": 133.00000000,
            "SIX": 0.10000000,
            "SKM": 38849.00000000,
            "SLICE": 234.00000000,
            "SLS": 0.00200000,
            "SLV": 0.00000000,
            "SMARTCREDIT": 2.80000000,
            "SMBSWAP": 248.00000000,
            "SNT": 2827.00000000,
            "SNX": 21.00000000,
            "SOLVE": 2849.00000000,
            "SPC": 2988.00000000,
            "SPHR": 0.10000000,
            "SPI": 1.60000000,
            "SPIN": 10.00000000,
            "SPY": 0.00000000,
            "SQ": 0.00000000,
            "SRN": 9961.00000000,
            "STC": 3700.00000000,
            "STEEM": 0.01000000,
            "STMX": 4856.00000000,
            "STORJ": 109.00000000,
            "STPT": 2988.00000000,
            "STRAX": 0.01000000,
            "STRK": 3.50000000,
            "SUKU": 387.00000000,
            "SUSD": 8.00000000,
            "SUTER": 969.00000000,
            "SWT": 160.00000000,
            "SXP": 49.00000000,
            "SYLO": 2152.00000000,
            "SYS": 0.00020000,
            "TEA": 685.00000000,
            "TEMCO": 10.00000000,
            "TFC": 0.10000000,
            "THC": 1.00000000,
            "TNC": 0.00000000,
            "TRAC": 377.00000000,
            "TRIO": 8888.00000000,
            "TRX": 0.00300000,
            "TRYB": 1877.00000000,
            "TSHP": 11426.00000000,
            "TSLA": 0.00000000,
            "TSM": 0.00000000,
            "TUBE": 0.01000000,
            "TUDA": 22852.00000000,
            "TUSD": 211.00000000,
            "TWTR": 0.00000000,
            "UBER": 0.00000000,
            "UBQ": 0.01000000,
            "UBT": 385.00000000,
            "UCT": 43165.00000000,
            "UMA": 17.00000000,
            "UNI": 5.00000000,
            "UPCO2": 38.00000000,
            "UPEUR": 173.00000000,
            "UPP": 1466.00000000,
            "UPT": 10500.00000000,
            "UPUSD": 237.00000000,
            "UPXAU": 0.10000000,
            "UQC": 8.00000000,
            "URAC": 194243.00000000,
            "URQA": 202.00000000,
            "USD": 0.00000000,
            "USDC": 211.00000000,
            "USDN": 0.10000000,
            "USDS": 212.00000000,
            "USDT": 211.00000000,
            "USO": 0.00000000,
            "UST": 3.08000000,
            "UTI": 97121.00000000,
            "UTK": 317.00000000,
            "VAL": 0.20000000,
            "VANY": 129495.00000000,
            "VBK": 0.05000000,
            "VDX": 146356.00000000,
            "VEE": 38849.00000000,
            "VET": 100.00000000,
            "VIA": 0.20000000,
            "VIB": 2100.00000000,
            "VID": 602.00000000,
            "VIL": 9.00000000,
            "VITE": 1133.00000000,
            "VLX": 0.01000000,
            "VRA": 6585.00000000,
            "VRC": 0.00020000,
            "VTC": 0.02000000,
            "WAVES": 0.00100000,
            "WAXP": 0.10000000,
            "WBTC": 0.00390000,
            "WGP": 19424.00000000,
            "WIB": 1.00000000,
            "WICC": 0.01000000,
            "WINGS": 2158.00000000,
            "WXBTC": 24.00000000,
            "XDB": 2123.00000000,
            "XDN": 0.02000000,
            "XEL": 0.20000000,
            "XELS": 35.00000000,
            "XEM": 4.00000000,
            "XHV": 0.01000000,
            "XLM": 0.05000000,
            "XMR": 0.00010000,
            "XMY": 0.20000000,
            "XNK": 2666.00000000,
            "XRP": 1.00000000,
            "XSR": 823.00000000,
            "XST": 0.02000000,
            "XTP": 194243.00000000,
            "XTZ": 0.25000000,
            "XUC": 546.00000000,
            "XVG": 5.00000000,
            "XWC": 0.01000000,
            "XYM": 1.00000000,
            "XYO": 12480.00000000,
            "YFL": 0.65000000,
            "YOU": 1494.00000000,
            "ZEC": 0.01000000,
            "ZEN": 0.00200000,
            "ZIL": 0.00200000,
            "ZM": 0.00000000,
            "ZRX": 113.00000000,
            "ZUSD": 12.00000000
        }

    def get_name(self):
        return self.__name

    def get_upper_bound_currency(self):
        return self.__upper_bound_currency

    def get_maker_taker_fees_list(self):
        return self.__maker_taker_fees

    def get_withdrawal_fees_list(self):
        return self.__withdrawal_fees

    def get_best_bid_offer_in_api_currency(self, currency):
        market = ApiRequest.make_request(
            f'{self.__URL_BUILD_CONTAINER["market_info_URL"]}/{currency}-{self.__upper_bound_currency}/{self.__URL_BUILD_CONTAINER["rates_endpoint"]}')
        if market is not None:
            return float(market["bidRate"])
        else:
            raise Exception("There is no highest bid in this API, biggest fee will be used to calculate total money")

    def get_maker_taker_fee(self, user_money_spent_on_api: float):
        i = 0
        length = len(self.get_maker_taker_fees_list())
        while i < length - 2:
            if user_money_spent_on_api > self.get_maker_taker_fees_list()[i]["upper_bound"]:
                i += 1
            else:
                return {"taker_fee": self.get_maker_taker_fees_list()[i]["takerFee"],
                        "maker_fee": self.get_maker_taker_fees_list()[i]["makerFee"]}
        if i == length - 2:
            return {"taker_fee": self.get_maker_taker_fees_list()[length - 1]["takerFee"],
                    "maker_fee": self.get_maker_taker_fees_list()[length - 1]["makerFee"]}

    def get_withdrawal_fee(self, currency: str):
        return self.__withdrawal_fees[currency]

    def request_bids_and_asks(self, currencies: tuple[str, str]):
        offers = ApiRequest.make_request(
            f'{self.__URL_BUILD_CONTAINER["URL"]}{currencies[0]}-{currencies[1]}/{self.__URL_BUILD_CONTAINER["orderbook_endpoint"]}')
        if offers is not None:
            return offers
        else:
            raise Exception(f"Empty bids and asks list in BITTREX for ({currencies[0]},{currencies[1]})")

    def request_market_data(self):
        markets = ApiRequest.make_request(f'{self.__URL_BUILD_CONTAINER["market_info_URL"]}')
        markets_list = []
        if markets is not None:
            for market in markets:
                symbols = re.split("-", market["symbol"])
                markets_list.append((symbols[0], symbols[1]))
        return markets_list
